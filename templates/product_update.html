{% extends "base.html" %}

{% block content %}
<h2>Update Product</h2>
<form id="product-form">
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="name" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">SKU</label>
            <input type="text" class="form-control" id="sku" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Base Price</label>
            <input type="number" step="0.01" class="form-control" id="base_price" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Offer %</label>
            <input type="number" step="0.01" class="form-control" id="offer_percent" value="0">
        </div>
    </div>

    <h4>Sizes</h4>
    <table class="table" id="sizes-table">
        <thead>
            <tr>
                <th>Size Name</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic rows -->
        </tbody>
    </table>
    <button type="button" class="btn btn-secondary mb-3" id="add-size-row">Add Size</button>
    <br>
    <button type="submit" class="btn btn-primary">Update Product</button>
    <a href="/products/" class="btn btn-outline-danger delete-existing">Cancel</a>
</form>

<script>
    const pathParts = window.location.pathname.split('/');
    // /products/<id>/update/ -> ID is index 2
    const productId = pathParts[2];

    document.addEventListener('DOMContentLoaded', async () => {
        if (!productId) return;

        // Load Product Data
        try {
            const res = await ApiClient.request(`/products/${productId}/`);
            if (res && res.ok) {
                const p = await res.json();
                document.getElementById('name').value = p.name;
                document.getElementById('sku').value = p.sku;
                document.getElementById('base_price').value = p.base_price;
                document.getElementById('offer_percent').value = p.offer_percent;

                // Load Sizes
                const tbody = document.querySelector('#sizes-table tbody');
                tbody.innerHTML = '';

                p.size_prices.forEach(size => {
                    addSizeRow(size.id, size.size_name, size.price);
                });
            }
        } catch (e) {
            showAlert('Error loading product', 'danger');
        }
    });

    function addSizeRow(id = null, name = '', price = '') {
        const tbody = document.querySelector('#sizes-table tbody');
        const row = document.createElement('tr');
        row.dataset.id = id || ''; // Store ID if existing

        row.innerHTML = `
        <td><input type="text" class="form-control size-name" value="${name}"></td>
        <td><input type="number" step="0.01" class="form-control size-price" value="${price}"></td>
        <td>
            ${id ? `<button type="button" class="btn btn-sm btn-outline-danger delete-existing" data-id="${id}">Delete</button>`
                : `<button type="button" class="btn btn-danger btn-sm remove-row">Remove</button>`}
        </td>
    `;
        tbody.appendChild(row);
    }

    document.getElementById('add-size-row').addEventListener('click', () => {
        addSizeRow();
    });

    // Event Delegation for Deletes
    document.querySelector('#sizes-table tbody').addEventListener('click', async (e) => {
        if (e.target.classList.contains('remove-row')) {
            // Just remove from DOM (not saved yet)
            e.target.closest('tr').remove();
        }
        else if (e.target.classList.contains('delete-existing')) {
            if (!confirm('Are you sure you want to delete this size variant?')) return;
            const sizeId = e.target.dataset.id;
            try {
                const res = await ApiClient.request(`/sizeprices/${sizeId}/`, 'DELETE');
                if (res && res.ok) {
                    e.target.closest('tr').remove();
                    showAlert('Size deleted', 'success');
                } else {
                    showAlert('Failed to delete size', 'danger');
                }
            } catch (err) {
                showAlert('Error deleting size', 'danger');
            }
        }
    });

    document.getElementById('product-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const productData = {
            name: document.getElementById('name').value,
            sku: document.getElementById('sku').value,
            base_price: document.getElementById('base_price').value,
            offer_percent: document.getElementById('offer_percent').value
        };

        try {
            // 1. Update Product details
            const res = await ApiClient.request(`/products/${productId}/`, 'PUT', productData);
            if (!res || !res.ok) throw new Error('Failed to update product');

            // 2. Handle Sizes (Update vs Create)
            const rows = document.querySelectorAll('#sizes-table tbody tr');
            for (const row of rows) {
                const existingId = row.dataset.id;
                const sizeName = row.querySelector('.size-name').value;
                const price = row.querySelector('.size-price').value;

                if (!sizeName || !price) continue;

                const payload = { size_name: sizeName, price: price, product: productId };

                if (existingId) {
                    // Update existing size
                    // Optimization: could check if changed, but simple put/patch is safer
                    await ApiClient.request(`/sizeprices/${existingId}/`, 'PUT', payload);
                } else {
                    // Create new size
                    // Wait for it to avoid race conditions or errors
                    await ApiClient.request(`/sizeprices/`, 'POST', payload);
                }
            }

            showAlert('Product updated successfully!', 'success');
            // Refresh to show consistent state or redirect
            setTimeout(() => window.location.href = '/products/', 1000);

        } catch (err) {
            console.error(err);
            showAlert('Error occurred during update', 'danger');
        }
    });
</script>
{% endblock %}